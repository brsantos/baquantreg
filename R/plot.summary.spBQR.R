#' Plot methods for summary of spatial Bayesian quantile regression models.
#'
#' Returns a ggplot of the estimates of the models and their respective
#'  credible intervals.
#'
#' @param x This is an object of the class "summary.spBQR",
#' produced by a call to the summary.spBQR function.
#' @param separate if FALSE, all plots are returned in the same output, and
#'  if TRUE the plot for each variable is returned separately. Default value
#'  is FALSE.
#' @param beta If TRUE, it plots the posterior estimates for beta(tau).
#'  Default is set to TRUE.
#' @param sigma If TRUE, it plots the posterior estimates for sigma.
#'  Default is set to FALSE.
#' @param lambda If TRUE, it plots the posterior estimates for lambda.
#'  Default is set to FALSE.
#' @param alpha If TRUE, it plots the posterior estimates for alpha.
#'  Default is set to FALSE.
#' @param ... other plot params (currently not used)
#' @return A ggplot of the posterior estimates with their credible intervals.
#' @export
#' @useDynLib baquantreg
#' @import ggplot2

plot.summary.spBQR <- function(x, separate = FALSE, beta = TRUE,
                               sigma = FALSE, lambda = FALSE,
                               alpha = FALSE, ...){
  if (class(x) != "summary.spBQR")
    stop("Look for the correct method for your model.")

  ntaus <- length(x$BetaPosterior)
  nvar <- dim(x$BetaPosterior[[1]])[1]

  vnames <- x$BetaPosterior[[1]][,1]

  postEst <- as.numeric(sapply(x$BetaPosterior, function(a) a[,2]))
  lowerQ <- as.numeric(sapply(x$BetaPosterior, function(a) a[,3]))
  upperQ <- as.numeric(sapply(x$BetaPosterior, function(a) a[,4]))

  taus <- x$taus

  plotData <- data.frame(vnames = rep(vnames, times=ntaus),
                         taus = rep(taus, each=nvar),
                         postEst = postEst,
                         lowerQ = lowerQ,
                         upperQ = upperQ)

  if (beta){
    if (!separate){
      g <- ggplot(plotData, aes(x=taus)) + theme_bw()
      g <- g + geom_line(aes(y=postEst)) + geom_line(aes(y=lowerQ), linetype=2) +
        ylab("Posterior estimates") + xlab(expression(taus)) +
        geom_line(aes(y=upperQ), linetype=2) + facet_wrap(~vnames, scales='free')

    }
    else {
      lapply(vnames, function(a){
        g <- ggplot(subset(plotData, vnames==a), aes(x=taus)) + theme_bw()
        g <- g +
          geom_line(aes(y=postEst)) + geom_line(aes(y=lowerQ), linetype=2) +
          ylab("Posterior estimates") + xlab(expression(tau)) +
          geom_line(aes(y=upperQ), linetype=2) +
          facet_wrap(~vnames, scales='free')
      })
    }
  }

  if (sigma){
    g1 <- ggplot(x$SigmaPosterior, aes(x=taus)) + theme_bw()
    g1 <- g1 + geom_line(aes(y=Mean)) +
      geom_line(aes(y=Lower), linetype=2) +
      geom_line(aes(y=Upper), linetype=2) +
      ylab("Posterior estimates for sigma") +
      xlab(expression(tau))
  }
  if (lambda){
    g2 <- ggplot(x$LambdaPosterior, aes(x=taus)) + theme_bw()
    g2 <- g2 + geom_line(aes(y=Mean)) +
      geom_line(aes(y=Lower), linetype=2) +
      geom_line(aes(y=Upper), linetype=2) +
      ylab("Posterior estimates for lambda") +
      xlab(expression(tau))
  }
  if (alpha){
    g3 <- ggplot(x$AlphaPosterior, aes(x=taus)) + theme_bw()
    g3 <- g3 + geom_line(aes(y=Mean)) +
      geom_line(aes(y=Lower), linetype=2) +
      geom_line(aes(y=Upper), linetype=2) +
      ylab("Posterior estimates for alpha") +
      xlab(expression(tau))
  }

  if (beta) print(g)
  if (sigma) print(g1)
  if (lambda) print(g2)
  if (alpha) print(g3)


}